#!/bin/bash

echo "==> Setup Airflow Workshop Umgebung starten..."

# 1. Logs und temporäre Dateien löschen (oder Berechtigungen setzen)
echo "-> Alte Logs und Lockfiles entfernen..."
sudo find ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/logs -type f -exec rm -f {} \; 2>/dev/null
sudo find ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/logs -type d -exec chmod 777 {} \; 2>/dev/null

# 2. Schreibrechte für wichtige Ordner setzen
echo "-> Schreibrechte setzen..."
sudo chmod -R u+rwX,g+rwX,o+rX ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/data
sudo chmod -R u+rwX,g+rwX,o+rX ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/dags
sudo chmod -R u+rwX,g+rwX,o+rX ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/plugins

# 2.1 Ownership korrekt setzen für Airflow (Container läuft mit UID 50000)
echo "-> Besitzerrechte für Airflow setzen (UID 50000)..."
sudo chown -R 50000:50000 ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/data
sudo chown -R 50000:50000 ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/logs
sudo chown -R 50000:50000 ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/dags
sudo chown -R 50000:50000 ~/Workshop-DE-Masterclass/Data-Pipelines/Airflow/plugins

# 3. Nicht versionierte Dateien sichern (falls nötig)
BACKUP_DIR=~/backup_airflow_files_$(date +%Y%m%d_%H%M%S)
echo "-> Nicht versionierte Dateien sichern (falls vorhanden) nach $BACKUP_DIR"
mkdir -p $BACKUP_DIR
git ls-files --others --exclude-standard -z | xargs -0 -I{} mv {} $BACKUP_DIR 2>/dev/null || echo "Keine untracked Dateien gefunden."

# 4. Änderungen stashen (lokale Änderungen sichern)
echo "-> Lokale Änderungen stashen (falls vorhanden)..."
git -C ~/Workshop-DE-Masterclass stash push -m "Auto-stash before pull" 2>/dev/null || echo "Nichts zu stashen."

# 5. Remote Änderungen holen und mergen
echo "-> Pull vom Remote-Repository durchführen..."
git -C ~/Workshop-DE-Masterclass pull origin main --rebase

# 6. Stash anwenden (lokale Änderungen wiederherstellen)
echo "-> Stash anwenden..."
git -C ~/Workshop-DE-Masterclass stash pop 2>/dev/null || echo "Kein Stash zum Anwenden."

echo "==> Setup abgeschlossen! Viel Erfolg im Workshop!"